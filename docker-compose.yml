services:
  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    networks:
      - internal_net

  api:
    build:
      context: ./portada_backend
    ports:
      - "8000:8000"
    environment:
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - DELTA_LAKE_PATH=/app/delta_lake
      - CONFIG_PATH=/app/config/delta_data_layer_config.json
      - PATH_TO_INGEST=/app/ingestion
    volumes:
      # Map the physical Delta Lake path from host to container
      - ./delta_lake:/app/delta_lake
      # Map a config folder if you have one, or create it empty for now
      - ./data_layer_config:/app/config
      - ./ingestion_zone:/app/ingestion
    depends_on:
      - redis
    networks:
      - internal_net

  frontend:
    build:
      context: ./frontend
    ports:
      - "5173:80"
    environment:
      - VITE_API_BASE_URL=http://api:8000/api/v1
    depends_on:
      - api
    networks:
      - internal_net
      
  monitor:
    build: ./monitor
    container_name: monitor_watcher
    volumes:
      - ./ingestion_zone:/app/ingestion
      - ./data_layer_config:/opt/dagster/app/data_layer_config
    environment:
      - DAGSTER_HOST=dagster_webserver
      - PATH_TO_WATCH=/app/ingestion
      - DATA_LAYER_CONFIG=/opt/dagster/app/data_layer_config/delta_data_layer_config.json
    depends_on:
      - dagster_webserver
    networks:
      - internal_net

  # 3. Dagster Webserver (Interf√≠cie de control)
  dagster_webserver:
    build: ./dagster
    container_name: dagster_webserver
    command: dagster-webserver -h 0.0.0.0 -p 3000 -w workspace.yaml
    environment:
      - DATA_LAYER_CONFIG=/opt/dagster/app/data_layer_config/delta_data_layer_config.json
    ports:
      - "3000:3000"
    volumes:
      - ./dagster:/opt/dagster/app
      - ./dades_persistents:/opt/dagster/dagster_home
      - ./data_layer_config:/opt/dagster/app/data_layer_config
    networks:
      - internal_net

  # 4. Dagster Daemon (L'encarregat d'executar els Jobs)
  dagster_daemon:
    build: ./dagster
    container_name: dagster_daemon
    command: dagster-daemon run
    environment:
      - DATA_LAYER_CONFIG=/opt/dagster/app/data_layer_config/delta_data_layer_config.json
    depends_on:
      - dagster_webserver
    volumes:
      - ./dagster:/opt/dagster/app
      - ./dades_persistents:/opt/dagster/dagster_home
      - ./dagster/dagster.yaml:/opt/dagster/dagster_home/dagster.yaml
      - ./ingestion_zone:/app/ingestion
      - ./data_layer_config:/opt/dagster/app/data_layer_config
      - ./delta_lake:/app/delta_test

networks:
  internal_net:
    driver: bridge

volumes:
  ingestion_zone:
  dades_persistents:
  delta_lake:
